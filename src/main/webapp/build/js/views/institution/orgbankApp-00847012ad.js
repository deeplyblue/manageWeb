angular.module("myApp").controller("queryCtrl",["$scope","$http","$httpParamSerializerJQLike","$log","OpenService","CheckboxService","CacheService","myConstant",function(e,a,n,t,o,r,l,g){function c(){var e=document.getElementById("queryForm");p.url=angular.element(e).prop("action"),p.postData=p.queryBean,p.postData.pageSize=p.pagination.pageSize,p.postData.pageNum=p.pagination.pageNum,a.post(p.url,n(p.postData)).then(function(e){var a=e.data;a.success?(p.pagination=a.object,r.clearChecked()):alert(a.msg)})}function s(){p.queryBean={}}function i(e,a){r.updateChecked(e,a),t.debug(a),t.debug(r.getChecked())}function d(){o({modalTitle:"新增机构银行信息",modalBody:"toUpdate",url:"update",orgBankInfo:p.cached.COMANY_CODE,cached:{CONN_CHANNEL:l.getCache("CONN_CHANNEL"),BANK_TYPE:l.getCache("BANK_TYPE")}},function(e){p.queryDetail()},"OrgBankModalInstanceCtrl")}function u(e){var t={1:"0",0:"1"},o=angular.copy(e);o.createTime=null,o.lastUpdTime=null,o.enableFlag=t[e.enableFlag],a.post(config.ctx+"/institution/orgbank/updateEnableFlag",n(o)).then(function(a){a.data.success?(e.enableFlag=o.enableFlag,alert("操作成功")):alert(a.data.msg)},function(e){alert("操作失败"),alert(e.status)})}function k(){return 1!=r.getChecked().length?void alert("必须勾选一条记录！"):(p.url=config.ctx+"/institution/orgbank/queryOrgBankInfo",p.postData={orgCode:r.getChecked()[0]},void a.post(p.url,n(p.postData)).then(function(e){var a=e.data;if(a.success){var n={};n[a.object.orgCode]=p.cached.COMANY_CODE[a.object.orgCode],o({modalTitle:"修改机构银行信息",modalBody:"toUpdate",item:a.object,orgBankInfo:n,url:"update",cached:{CONN_CHANNEL:l.getCache("CONN_CHANNEL"),BANK_TYPE:l.getCache("BANK_TYPE")}},function(e){p.queryDetail()},"OrgBankModalInstanceCtrl")}else alert(a.msg)}))}function B(){return 1!=r.getChecked().length?void alert("必须勾选一条记录！"):void a.post("delete",n({userId:r.getChecked()[0]})).then(function(e){var a=e.data;if(a.success){var n=p.pagination.list.filter(function(e,a,n){return e.userId==r.getChecked()[0]})[0];p.pagination.list.splice(p.pagination.list.indexOf(n),1),alert("操作成功")}else alert("操作失败")},function(e){alert(e.statusText),t.debug("error")})}var p=e.vm={};p.constant=g,p.pagination={pageSize:10,pageNum:1},p.queryBean={},p.queryDetail=c,p.resetForm=s,p.updateChecked=i,p.addItem=d,p.updateItem=k,p.deleteItem=B,p.queryOrgBankInfo=p.queryOrgBankInfo,p.updateItemEnableFlag=u,p.cached={COMANY_CODE:{},BANK_TYPE:{},CONN_CHANNEL:{},ENABLE_FLAG:{}},l.initCache(p.cached)}]),angular.module("myApp").controller("OrgBankModalInstanceCtrl",["$scope","$uibModalInstance","modalItem","$http","$httpParamSerializerJQLike","myConstant",function(e,a,n,t,o,r){function l(e){for(var a=u.cached.BANK_TYPE,n=new Array,t=0,o=0;o<a.length;o++){var r=a[o].key;r.substr(0,e.length)==e&&(n[t]=a[o],t++)}u.bankTypes=n,u.orgBanks=new Array,document.getElementById("orgBanks").style.display="none"}function g(e,a){var n=e.target;if(n.checked)for(var t=0;t<u.orgBanks.length;t++)u.orgBanks[t].bankCode==a&&(u.orgBanks[t].choose="1",s(t,1));else for(var t=0;t<u.orgBanks.length;t++)u.orgBanks[t].bankCode==a&&(u.orgBanks[t].choose="0",s(t,0))}function c(e){var a=e.target;if(a.checked)for(var n=0;n<u.orgBanks.length;n++)u.orgBanks[n].choose="1",s(n,1);else for(var n=0;n<u.orgBanks.length;n++)u.orgBanks[n].choose="0",s(n,0)}function s(e,a){1==a?(u.orgBanks[e].orgBankCode=u.orgBanks[e].bankName,u.orgBanks[e].orgBankCodeDesc=u.orgBanks[e].bankCode):(u.orgBanks[e].orgBankCode="",u.orgBanks[e].orgBankCodeDesc="")}function i(e){u.url=config.ctx+"/institution/orgbank/getOrgBankInfo",null!=u.item.orgCode&&""!=u.item.orgCode&&(u.postData={bankType:e,companyType:"02",companyCode:u.item.orgCode},t.post(u.url,o(u.postData)).then(function(e){var a=e.data;a.success?(0==a.object.length?document.getElementById("orgBanks").style.display="none":document.getElementById("orgBanks").style.display="block",u.orgBanks=a.object):(document.getElementById("orgBanks").style.display="none",alert(a.msg))}))}function d(e,a){var n=e.target;if(n.checked)for(var t=0;t<u.orgBanks.length;t++)u.orgBanks[t].bankCode==a&&(u.orgBanks[t].payLvl="1");else for(var t=0;t<u.orgBanks.length;t++)u.orgBanks[t].bankCode==a&&(u.orgBanks[t].payLvl="0")}var u=e.vm={modalTitle:"please change the title",modalBody:"#",url:"",item:{}};u=e.vm=n,u.constant=r,u.getOrgBankInfo=i,u.chooseAll=c,u.getBankType=l,u.orgBanks=new Array,u.updateChecked=g,u.setPayLvlBox=d,u.getBusiDesc=function(e,a){return a+"("+e+")"},e.save=function(){u.url=config.ctx+"/institution/orgbank/saveOrgBank";var a={headers:{"Content-Type":"application/json"}};if(null==u.item.refundDeadline||""==u.item.refundDeadline)return void alert("请填写退款期限");for(var n=0;n<u.orgBanks.length;n++)if(u.orgBanks[n].refundDeadline=u.item.refundDeadline,u.orgBanks[n].orgRefundLimit=u.item.orgRefundLimit,"1"==u.orgBanks[n].choose&&(""==u.orgBanks[n].orgBankCode||null==u.orgBanks[n].orgBankCode||""==u.orgBanks[n].orgBankCodeDesc||null==u.orgBanks[n].orgBankCodeDesc))return void alert("请填写外系统银行代码");t.post(u.url,u.orgBanks,a).then(function(a){var n=a.data;n.success?e.cancel():(alert(n.msg),e.cancel())})},e.cancel=function(){a.dismiss("cancel")}}]);