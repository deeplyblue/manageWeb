angular.module("myApp").controller("queryCtrl",["$scope","$http","$httpParamSerializerJQLike","$log","OpenService","CheckboxService","CacheService","limitToFilter","filterFilter","myConstant",function(e,t,a,n,i,o,c,r,l,d){function u(){var e=document.getElementById("queryForm");C.url=angular.element(e).prop("action"),C.postData=C.queryBean,C.postData.pageSize=C.pagination.pageSize,C.postData.pageNum=C.pagination.pageNum,t.post(C.url,a(C.postData)).then(function(e){var t=e.data;t.success?(C.pagination=t.object,o.clearChecked()):alert(t.msg)})}function p(){var e=C.queryBean.companyType;C.queryBean={},C.queryBean.companyType=e}function m(e,t){o.updateChecked(e,t),n.debug(t),n.debug(o.getChecked())}function s(){t.post(config.ctx+"/institution/transRight/initResource",a({})).then(function(e){i({modalTitle:"增加交易权限",modalBody:"toAdd",url:"add",item:{treeData:e.data.object},cached:{COMANY_CODE:c.getCache("COMANY_CODE")}},function(e){},"privateMerchantCtrl","myModalNoFooter.html")},function(e){alert("访问失败")})}function g(){if(1!=o.getCheckedNew(C.pagination.list).length)return void alert("必须勾选一条记录！");var e=o.getCheckedNew(C.pagination.list)[0].companyCode;n.info("----%s",e),t.post(config.ctx+"/institution/transRight/initResource",a({merchantCode:e,companyType:C.queryBean.companyType})).then(function(t){i({modalTitle:"交易权限权限分配",modalBody:"toUpdate",url:"update",item:{merchantCode:e,treeData:t.data.object,COMANY_CODE:C.cached.COMANY_CODE}},function(e){},"privateMerchantCtrl")},function(e){alert("访问失败")})}function h(){return 1!=o.getCheckedNew(C.pagination.list).length?void alert("必须勾选一条记录！"):void t.post("delete",a({companyCode:o.getCheckedNew(C.pagination.list)[0].companyCode})).then(function(e){var t=e.data;t.success?(C.pagination.list.splice(C.pagination.list.indexOf(o.getCheckedNew(C.pagination.list)[0]),1),C.queryDetail(),alert("操作成功")):alert("操作失败")},function(e){alert(e.statusText),n.debug("error")})}var C=e.vm={};C.constant=d,C.pagination={pageSize:10,pageNum:1},C.queryBean={},C.reverseFlag={1:"正交易",0:"反交易"},C.splitRightFlag={0:"分账交易",1:"非分账交易"},C.cached={COMANY_CODE:{},TRANS_CODE_ALL:{},CONN_CHANNEL:{},REFUND_FLAG:{}},c.initCache(C.cached),C.getCache=function(e){return c.getCache(e)},C.getObj=function(e,i){return t.post(config.ctx+"/base/cache/getAll",a({cacheKey:e})).then(function(e){return r(l(e.data.object,i),6)},function(e){n.error("获取数据%s失败",cacheKey)})},C.queryDetail=u,C.resetForm=p,C.updateChecked=m,C.addItem=s,C.updateItem=g,C.deleteItem=h}]),angular.module("myApp").controller("privateMerchantCtrl",["$scope","$uibModalInstance","modalItem","$http","$httpParamSerializerJQLike","$log","$timeout",function(e,t,a,n,i,o,c){var r=e.vm={modalTitle:"please change the title",modalBody:"#",url:"",item:{id:"",treeData:{}}};r=e.vm=a,c(function(){function e(t,a){t.nodes&&t.nodes.length>0&&t.nodes.forEach(function(t){e(t,a)}),a.push({id:t.id,pId:t.pid,name:t.name,checked:t.checked})}var t={check:{enable:!0},data:{simpleData:{enable:!0}}},a=[];r.item.treeData.forEach(function(t){e(t,a)}),$.fn.zTree.init(angular.element(".ztree"),t,a)},1e3),e.save=function(){var e=$.fn.zTree.getZTreeObj("treeDemo"),a=e.getCheckedNodes(),o=[];if(0==a.length)return alert("操作失败,渠道/订单类型不能为空"),!1;for(var c in a){var l={acqOrgCode:r.item.acqOrgCode,companyType:r.item.companyType,companyCode:r.item.merchantCode,transCode:a[c].id,connChannel:a[c].pId};o.push(l)}n.post(r.url,i({tempParams:JSON.stringify(o)})).then(function(e){e.data.success?(alert("操作成功"),t.close(r.item)):alert(e.data.msg)},function(e){alert("操作失败")})},e.cancel=function(){t.dismiss("cancel")}}]);