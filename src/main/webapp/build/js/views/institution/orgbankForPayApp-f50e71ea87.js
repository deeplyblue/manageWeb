angular.module("myApp").controller("queryCtrl",["$scope","$http","$httpParamSerializerJQLike","$log","OpenService","CheckboxService","CacheService","limitToFilter","filterFilter","myConstant","growl",function(e,t,a,n,o,r,c,i,g,l,s){function d(){var e=document.getElementById("queryForm");B.url=angular.element(e).prop("action"),B.postData=B.queryBean,B.postData.pageSize=B.pagination.pageSize,B.postData.pageNum=B.pagination.pageNum,t.post(B.url,a(B.postData)).then(function(e){var t=e.data;t.success?(B.pagination=t.object,r.clearChecked()):alert(t.msg)})}function u(){B.queryBean={}}function C(e,t){r.updateChecked(e,t),n.debug(t),n.debug(r.getChecked())}function h(){o({modalTitle:"添加支付策略 ",modalBody:"toAddForPay",url:"addForPay",orgBankInfo:B.cached.COMANY_CODE,cached:{CONN_CHANNEL:c.getCache("CONN_CHANNEL"),BANK_TYPE:c.getCache("BANK_TYPE"),TRANS_CODE:c.getCache("TRANS_CODE"),ORG_BANK_CODE_DESC:c.getCache("ORG_BANK_CODE_DESC"),TRANS_CODE_02:c.getCache("TRANS_CODE_02")}},function(e){o({modalTitle:"添加支付策略 ",modalBody:"toAddForPayTwo",url:"addForPayTwo",orgBankInfo:B.cached.COMANY_CODE,cached:{CONN_CHANNEL:c.getCache("CONN_CHANNEL"),BANK_TYPE:c.getCache("BANK_TYPE"),TRANS_CODE:c.getCache("TRANS_CODE"),ORG_BANK_CODE_DESC:c.getCache("ORG_BANK_CODE_DESC")}},function(e){B.queryDetail()},"OrgBankModalInstanceCtrl")},"OrgBankModalInstanceCtrl")}function m(){return 1!=r.getChecked().length?void alert("必须勾选一条记录！"):(B.url=config.ctx+"/institution/orgbank/queryOrgBankInfo",B.postData={orgCode:r.getChecked()[0]},void t.post(B.url,a(B.postData)).then(function(e){var t=e.data;if(t.success){var a={};a[t.object.orgCode]=B.cached.COMANY_CODE[t.object.orgCode],o({modalTitle:"修改机构信息",modalBody:"toUpdateForPay",item:t.object,orgBankInfo:a,url:"updateForPay",cached:{CONN_CHANNEL:c.getCache("CONN_CHANNEL"),BANK_TYPE:c.getCache("BANK_TYPE")}},function(e){B.queryDetail()},"OrgBankModalInstanceCtrl")}else alert(t.msg)}))}function f(e){e?t.post(config.ctx+"/institution/orgbank/queryOrgBankByBank",e,config.jsonHeader).then(function(t){o({modalTitle:"支付策略配置",modalBody:"toUpdateForPay",item:angular.copy(e),list:t.data.object,disable:!0,url:config.ctx+"/institution/payChanStrategyCfg/edit",cached:{CONN_CHANNEL:c.getCache("CONN_CHANNEL"),BANK_TYPE:c.getCache("BANK_TYPE"),COMANY_CODE:c.getCache("COMANY_CODE"),PAY_TRANS_CODE:c.getCache("PAY_TRANS_CODE"),ORG_BANK_CODE_DESC:c.getCache("ORG_BANK_CODE_DESC")}},function(e){B.queryDetail()},"EditForPayModalInstanceCtrl")}):o({modalTitle:"支付策略配置",modalBody:"toUpdateForPay",item:{},list:{},url:config.ctx+"/institution/payChanStrategyCfg/edit",cached:{CONN_CHANNEL:c.getCache("CONN_CHANNEL"),BANK_TYPE:c.getCache("BANK_TYPE"),COMANY_CODE:c.getCache("COMANY_CODE"),PAY_TRANS_CODE:c.getCache("PAY_TRANS_CODE"),ORG_BANK_CODE_DESC:c.getCache("ORG_BANK_CODE_DESC")}},function(e){B.queryDetail()},"EditForPayModalInstanceCtrl")}function k(){return 1!=r.getChecked().length?void alert("必须勾选一条记录！"):void t.post("delete",a({userId:r.getChecked()[0]})).then(function(e){var t=e.data;if(t.success){var a=B.pagination.list.filter(function(e,t,a){return e.userId==r.getChecked()[0]})[0];B.pagination.list.splice(B.pagination.list.indexOf(a),1),alert("操作成功")}else alert("操作失败")},function(e){alert(e.statusText),n.debug("error")})}var B=e.vm={};B.constant=l,B.pagination={pageSize:10,pageNum:1},B.queryBean={},B.queryDetail=d,B.resetForm=u,B.updateChecked=C,B.addItem=h,B.updateItem=m,B.deleteItem=k,B.editItem=f,B.queryOrgBankInfo=B.queryOrgBankInfo,B.cached={COMANY_CODE:{},BANK_TYPE:{},CONN_CHANNEL:{},TRANS_CODE:{},PAY_TRANS_CODE:{},ORG_BANK_CODE_DESC:{},TRANS_CODE_02:{}},c.initCache(B.cached),B.getCache=function(e){return c.getCache(e)},B.getObj=function(e,o){return t.post(config.ctx+"/base/cache/getAll",a({cacheKey:e})).then(function(e){return i(g(e.data.object,o),6)},function(e){n.error("获取数据%s失败",cacheKey)})}}]),angular.module("myApp").controller("OrgBankModalInstanceCtrl",["$scope","$uibModalInstance","modalItem","$http","$httpParamSerializerJQLike","myConstant",function(e,t,a,n,o,r){function c(e){for(var t=d.cached.BANK_TYPE,a=new Array,n=0,o=0;o<t.length;o++){var r=t[o].key;r.substr(0,e.length)==e&&(a[n]=t[o],n++)}d.bankTypes=a,d.orgBanks=new Array,document.getElementById("orgBanks").style.display="none"}function i(e,t){var a=e.target;if(a.checked)for(var n=0;n<d.orgBanks.length;n++)d.orgBanks[n].bankCode==t&&(d.orgBanks[n].choose="1");else for(var n=0;n<d.orgBanks.length;n++)d.orgBanks[n].bankCode==t&&(d.orgBanks[n].choose="0")}function g(e){var t=e.target;if(t.checked)for(var a=0;a<d.orgBanks.length;a++)d.orgBanks[a].choose="1";else for(var a=0;a<d.orgBanks.length;a++)d.orgBanks[a].choose="0"}function l(e){d.url=config.ctx+"/institution/orgbank/getOrgBankInfo",null!=d.item.orgCode&&""!=d.item.orgCode&&(d.postData={bankType:e,companyType:"02",companyCode:d.item.orgCode},n.post(d.url,o(d.postData)).then(function(e){var t=e.data;t.success?(0==t.object.length?document.getElementById("orgBanks").style.display="none":document.getElementById("orgBanks").style.display="block",d.orgBanks=t.object):(document.getElementById("orgBanks").style.display="none",alert(t.msg))}))}function s(e,t){var a=e.target;if(a.checked)for(var n=0;n<d.orgBanks.length;n++)d.orgBanks[n].bankCode==t&&(d.orgBanks[n].payLvl="1");else for(var n=0;n<d.orgBanks.length;n++)d.orgBanks[n].bankCode==t&&(d.orgBanks[n].payLvl="0")}var d=e.vm={modalTitle:"please change the title",modalBody:"#",url:"",item:{}};d=e.vm=a,d.constant=r,d.getOrgBankInfo=l,d.chooseAll=g,d.getBankType=c,d.orgBanks=new Array,d.updateChecked=i,d.setPayLvlBox=s,e.save=function(){d.url=config.ctx+"/institution/orgbank/saveOrgBank";for(var t={headers:{"Content-Type":"application/json"}},a=0;a<d.orgBanks.length;a++)if(d.orgBanks[a].refundDeadline=d.item.refundDeadline,d.orgBanks[a].orgRefundLimit=d.item.orgRefundLimit,"1"==d.orgBanks[a].choose&&(""==d.orgBanks[a].orgBankCode||null==d.orgBanks[a].orgBankCode))return void alert("请填写外系统银行代码");n.post(d.url,d.orgBanks,t).then(function(t){var a=t.data;a.success?e.cancel():(alert(a.msg),e.cancel())})},e.cancel=function(){t.dismiss("cancel")}}]),angular.module("myApp").controller("EditForPayModalInstanceCtrl",["$scope","$uibModalInstance","modalItem","$http","$httpParamSerializerJQLike","$log","myConstant",function(e,t,a,n,o,r,c){function i(){g.item.bankCode&&n.post(config.ctx+"/institution/orgbank/queryOrgBank",{bankCode:g.item.bankCode},config.jsonHeader).then(function(e){if(e.data.success){var t=e.data.object.map(function(e){return e.orgCode});r.debug(t),g.orgBanks=g.cached.COMANY_CODE.filter(function(e){if(t.indexOf(e.key)!=-1)return r.debug(e.key),!0})}else alert("获取对应支付机构失败")},function(e){alert("获取对应支付机构失败")})}var g=e.vm={modalTitle:"please change the title",modalBody:"#",url:"",item:{}};g=e.vm=a;var l={orgCode:"",stgyPriority:"",enableFlag:""};g.list&&0!=g.list.length?g.item.orgs=g.list:g.item.orgs=[angular.copy(l)],i(),g.constant=c,g.addItem=function(){g.item.orgs.push(angular.copy(l))},g.deleteItem=function(e){g.item.orgs.splice(e,1),0==e&&g.item.orgs.push(angular.copy(l))},g.queryOrgs=function(){if(g.item.bankCode&&g.item.transCode&&g.item.connChannel){var e=angular.copy(g.item);delete e.orgs,i(),n.post(config.ctx+"/institution/orgbank/queryOrgBankByBank",e,config.jsonHeader).then(function(e){e.data.success?(g.item.orgs=e.data.object,0==e.data.object.length&&g.item.orgs.push(angular.copy(l))):alert("获取对应支付机构失败")},function(e){alert("获取对应支付机构失败")})}},e.save=function(){var e=g.item.orgs.map(function(e){var t={};return t.orgCode=e.orgCode,t.stgyPriority=e.stgyPriority,t.status=e.enableFlag,t.bankCode=g.item.bankCode,t.transCode=g.item.transCode,t.connChannel=g.item.connChannel,t});n.post(g.url,e,config.jsonHeader).then(function(e){e.data.success?(alert("操作成功"),t.close(g.item)):alert(e.data.msg)},function(e){alert("操作失败"),alert(e.status)})},e.cancel=function(){t.dismiss("cancel")}}]);