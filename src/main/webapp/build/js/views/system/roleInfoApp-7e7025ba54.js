angular.module("myApp").controller("queryCtrl",["$scope","$http","$httpParamSerializerJQLike","$log","OpenService","CheckboxService","CacheService","limitToFilter","filterFilter","myConstant",function(e,t,a,n,o,l,i,c,r,d){function u(e){t.post(config.ctx+"/system/role/initResource",a({id:e})).then(function(t){o({modalTitle:"权限分配",modalBody:"toAllocate",url:"allocate",item:{id:e,treeData:t.data.object}},function(e){},"privateModalInstanceCtrl")},function(e){alert("访问失败")})}function s(){var e=document.getElementById("queryForm");y.url=angular.element(e).prop("action"),y.postData=y.queryBean,y.postData.pageSize=y.pagination.pageSize,y.postData.pageNum=y.pagination.pageNum,t.post(y.url,a(y.postData)).then(function(e){var t=e.data;t.success?(y.pagination=t.object,l.clearChecked()):alert(t.msg)})}function p(){y.queryBean={}}function m(e,t){l.updateChecked(e,t),n.debug(t),n.debug(l.getChecked())}function g(){o({modalTitle:"新增角色",modalBody:"toAdd",url:"add",item:{},cached:{ROLE_TYPE:i.getCache("ROLE_TYPE")}},function(e){s()},"","myModalNoFooter.html")}function h(){return 1!=l.getChecked().length?void alert("必须勾选一条记录！"):void o({modalTitle:"修改角色",modalBody:"toUpdate",url:"update",item:y.pagination.list.filter(function(e,t,a){if(e.roleId==l.getChecked()[0])return e.createTime=null,e.lastUpdTime=null,!0})[0],cached:{ROLE_TYPE:i.getCache("ROLE_TYPE")}},function(e){s()},"","myModalNoFooter.html")}function f(){return 1!=l.getChecked().length?void alert("必须勾选一条记录！"):void t.post("delete",a({roleId:l.getChecked()[0]})).then(function(e){var t=e.data;if(t.success){var a=y.pagination.list.filter(function(e,t,a){return e.roleId==l.getChecked()[0]})[0];y.pagination.list.splice(y.pagination.list.indexOf(a),1),alert("操作成功")}else alert("操作失败")},function(e){alert(e.statusText),n.debug("error")})}var y=e.vm={};y.constant=d,y.pagination={pageSize:10,pageNum:1},y.queryBean={},y.cached={ROLE_INFO:{},ROLE_TYPE:{}},i.initCache(y.cached),y.getCache=function(e){return i.getCache(e)},y.getObj=function(e,o){return t.post(config.ctx+"/base/cache/getAll",a({cacheKey:e})).then(function(e){return c(r(e.data.object,o),6)},function(e){n.error("获取数据%s失败",cacheKey)})},y.queryDetail=s,y.resetForm=p,y.updateChecked=m,y.addItem=g,y.updateItem=h,y.deleteItem=f,y.resourceAllocate=u}]),angular.module("myApp").controller("privateModalInstanceCtrl",["$scope","$uibModalInstance","modalItem","$http","$httpParamSerializerJQLike","$log","$timeout",function(e,t,a,n,o,l,i){function c(e){var t=$.fn.zTree.getZTreeObj("treeDemo"),a=e.data.type,n=t.getSelectedNodes();a.indexOf("All")<0&&0==n.length&&alert("请先选择一个父节点"),"expandAll"==a?t.expandAll(!0):"collapseAll"==a&&t.expandAll(!1)}var r=e.vm={modalTitle:"please change the title",modalBody:"#",url:"",item:{id:"",treeData:{}}};r.expandNode=c,r=e.vm=a,e.save=function(){var e=$.fn.zTree.getZTreeObj("treeDemo"),a=e.getCheckedNodes(),l=a.map(function(e){return e.id});n.post(r.url,o({id:r.item.id,ids:l})).then(function(e){e.data.success?(alert("操作成功"),t.close(r.item)):alert(e.data.msg)},function(e){alert("操作失败")})},e.cancel=function(){t.dismiss("cancel")},i(function(){function e(t,a){t.nodes&&t.nodes.length>0&&t.nodes.forEach(function(t){e(t,a)}),a.push({id:t.rsrcCode,pId:t.parentRsrcCode,name:t.text,checked:!!t.state&&t.state.checked})}var t={check:{enable:!0,chkboxType:{Y:"ps",N:"s"}},data:{simpleData:{enable:!0}}},a=[];r.item.treeData.forEach(function(t){e(t,a)}),$.fn.zTree.init(angular.element(".ztree"),t,a),$("#expandAllBtn").bind("click",{type:"expandAll"},c),$("#collapseAllBtn").bind("click",{type:"collapseAll"},c)},1e3)}]);