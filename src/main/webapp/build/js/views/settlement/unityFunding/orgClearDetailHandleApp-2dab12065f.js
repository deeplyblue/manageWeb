angular.module("myApp").controller("queryCtrl",["$scope","$http","$httpParamSerializerJQLike","$log","OpenService","CheckboxService","CacheService","limitToFilter","filterFilter","dateFilter","myConstant","DateCalculateService",function(e,t,a,l,r,o,n,c,u,d,s,i){function m(){var e=document.getElementById("queryForm");g.url=angular.element(e).prop("action");var l=angular.copy(g.queryBean);l.pageSize=g.pagination.pageSize,l.pageNum=g.pagination.pageNum,l.beginDate=d(l.clrDateBegin,"yyyyMMdd"),l.endDate=d(l.clrDateEnd,"yyyyMMdd"),l.clrDateBegin=null,l.clrDateEnd=null,t.post(g.url,a(l)).then(function(e){var t=e.data;t.success?g.pagination=t.object:alert(t.msg)},function(e){alert("操作失败")})}function p(){g.queryBean={}}function y(e){var o;t.post(config.ctx+"/settlement/unityFunding/orgClearDetail/queryClearDetail",a({clrBatchNo:e.clrBatchNo,clrType:e.clrType,clrFlag:e.clrFlag,beginDate:d(g.queryBean.clrDateBegin,"yyyyMMdd"),endDate:d(g.queryBean.clrDateEnd,"yyyyMMdd")})).then(function(t){var a=t.data;return a.success?(o=a.object,void r({modalTitle:"结算明细【"+e.clrBatchNo+"】",modalBody:"toClearDetail",url:"#",item:o,clrFlag:e.clrFlag,cached:{CLR_FLAG:g.cached.CLR_FLAG,COMANY_CODE:g.cached.COMANY_CODE,REPORT_TYPE:g.cached.REPORT_TYPE,CLR_TYPE:g.cached.CLR_TYPE,CLR_ADJUST_FLAG:g.cached.CLR_ADJUST_FLAG}},function(e){l.debug(e),g.queryDetail()},"OrgClearHandleDetailCtrl","myModalNoFooter.html")):(alert("未找到相关数据"),!1)})}var g=e.vm={};g.constant=s,g.downCfg={contentType:"jqLike",date:{clrDate:"yyyyMMdd",settleDateBegin:"yyyyMMdd",settleDateEnd:"yyyyMMdd"}},g.pagination={pageSize:10,pageNum:1},g.sumObject={},g.queryBean={},g.queryBean.clrDateBegin=i.getToday(),g.queryBean.clrDateEnd=i.getToday(),g.cached={CLR_FLAG:{},COMANY_CODE:{},REPORT_TYPE:{},CLR_TYPE:{},CLR_ADJUST_FLAG:{}},n.initCache(g.cached),g.getCache=function(e){return n.getCache(e)},g.getObj=function(e,r){return t.post(config.ctx+"/base/cache/getAll",a({cacheKey:e})).then(function(e){return c(u(e.data.object,r),6)},function(e){l.error("获取数据%s失败",cacheKey)})},g.queryDetail=m,g.resetForm=p,g.toClearDetail=y}]),angular.module("myApp").controller("OrgClearHandleDetailCtrl",["$scope","$uibModalInstance","modalItem","$http","$httpParamSerializerJQLike","$log","dateFilter","CheckboxService","$timeout",function(e,t,a,l,r,o,n,c,u){function d(e){i(),e.transAmtP=parseFloat(e.transAmtP)+100*parseFloat(m.adjustModel.payableAmt),e.transCountP=parseFloat(e.transCountP)+parseFloat(m.adjustModel.payableCount),e.transAmtR=parseFloat(e.transAmtR)+100*parseFloat(m.adjustModel.receivableAmt),e.transCountR=parseFloat(e.transCountR)+parseFloat(m.adjustModel.receivableCount),e.feeAmtR=parseFloat(e.feeAmtR)+100*parseFloat(m.adjustModel.reFeeAmt),e.feeAmtP=parseFloat(e.feeAmtP)+100*parseFloat(m.adjustModel.feeAmt)}function s(e){i(),e.transAmtP=parseFloat(e.transAmtP)-100*parseFloat(m.adjustModel.payableAmt),e.transCountP=parseFloat(e.transCountP)-parseFloat(m.adjustModel.payableCount),e.transAmtR=parseFloat(e.transAmtR)-100*parseFloat(m.adjustModel.receivableAmt),e.transCountR=parseFloat(e.transCountR)-parseFloat(m.adjustModel.receivableCount),e.feeAmtR=parseFloat(e.feeAmtR)-100*parseFloat(m.adjustModel.reFeeAmt),e.feeAmtP=parseFloat(e.feeAmtP)-100*parseFloat(m.adjustModel.feeAmt)}function i(){angular.isNumber(m.adjustModel.payableAmt)||(m.adjustModel.payableAmt=0),angular.isNumber(m.adjustModel.receivableAmt)||(m.adjustModel.receivableAmt=0),angular.isNumber(m.adjustModel.reFeeAmt)||(m.adjustModel.reFeeAmt=0),angular.isNumber(m.adjustModel.feeAmt)||(m.adjustModel.feeAmt=0),angular.isNumber(m.adjustModel.payableCount)||(m.adjustModel.payableCount=0),angular.isNumber(m.adjustModel.receivableCount)||(m.adjustModel.receivableCount=0)}var m=e.vm={modalTitle:"please change the title",modalBody:"#",url:"",item:{},clrFlag:""};m=e.vm=a,m.adjustModel={},m.item.list.forEach(function(e){e.collapse=!0}),m.checked=[],m.handleSome=function(){return 0==c.getCheckedNew(m.item.list).length?void alert("请选择记录！"):void(confirm("确认经办？")&&l.post(config.ctx+"/settlement/unityFunding/orgClearDetail/handle",r({checked:c.getCheckedNew(m.item.list).map(function(e){return e.orgCode+"#"+e.clrType+"#"+n(e.clrDate,"yyyyMMdd")}),clrBatchNo:c.getCheckedNew(m.item.list)[0].clrBatchNo})).then(function(t){var a=t.data;a.success?(alert("经办成功!"),e.cancel()):alert("经办失败!")},function(){alert("经办失败!")}))},m.toggleAdjust=function(e){return 0==e.collapse?void(e.collapse=!0):(e.collapse=!1,void(m.adjustModel={}))},m.queryAdjust=function(e){return 0==e.collapse?(e.collapse=!0,void d(e)):(m.adjustModel.payOrgCode=e.orgCode,m.adjustModel.clrDate=e.clrDate,m.adjustModel.clrBatchNo=e.clrBatchNo,m.adjustModel.clrType=e.clrType,void l.post(config.ctx+"/settlement/unityFunding/payClearDetailAdjust/query",m.adjustModel,config.jsonHeader).then(function(t){var a=t.data;a.success?(m.adjustModel=a.object,s(e),e.collapse=!1):alert("系统忙,请稍后再试")},function(e){alert(e.data.msg)}))},m.saveAdjust=function(e,t){var a=angular.copy(t);isNaN(parseFloat(a.payableAmt))&&(a.payableAmt=0),isNaN(parseFloat(a.receivableAmt))&&(a.receivableAmt=0),isNaN(parseFloat(a.reFeeAmt))&&(a.reFeeAmt=0),isNaN(parseFloat(a.feeAmt))&&(a.feeAmt=0),isNaN(parseFloat(a.payableCount))&&(a.payableCount=0),isNaN(parseFloat(a.receivableCount))&&(a.receivableCount=0),a.payableAmt=100*a.payableAmt,a.receivableAmt=100*a.receivableAmt,a.reFeeAmt=100*a.reFeeAmt,a.feeAmt=100*a.feeAmt,a.clrNetAmt=a.payableAmt-a.receivableAmt,a.clrAmt=a.reFeeAmt-a.feeAmt,a.payOrgCode=e.orgCode,a.clrDate=e.clrDate,a.clrBatchNo=e.clrBatchNo,a.clrType=e.clrType,l.post(config.ctx+"/settlement/unityFunding/payClearDetailAdjust/save",a,config.jsonHeader).then(function(t){var a=t.data;a.success?(alert("保存成功！"),e.collapse=!0,e.clrAdjustFlag="02",d(e)):alert(a.msg)},function(e){alert("操作失败")})},e.save=function(){},e.cancel=function(){t.dismiss("cancel")}}]);