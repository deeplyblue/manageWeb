angular.module("myApp").controller("queryCtrl",["$scope","$http","$httpParamSerializerJQLike","$log","OpenService","CheckboxService","CacheService","limitToFilter","filterFilter","myConstant","growl",function(e,t,a,n,l,o,i,r,c,s,u){function d(){var e=document.getElementById("queryForm");T.url=angular.element(e).prop("action"),T.postData=T.queryBean,T.postData.pageSize=T.pagination.pageSize,T.postData.pageNum=T.pagination.pageNum,t.post(T.url,a(T.postData)).then(function(e){var t=e.data;t.success?(T.pagination=t.object,o.clearChecked()):alert(t.msg)})}function m(){T.queryBean={}}function g(){l({modalTitle:"新增用户",modalBody:"toAdd",url:"add",item:{},cached:{USER_TYPE:i.getCache("USER_TYPE"),DPET_NAME:i.getCache("DPET_NAME"),MERCHANT_CODE:i.getCache("MERCHANT_CODE")}},function(e){T.pagination&&T.pagination.list&&d()})}function p(){if(1!=o.getCheckedNew(T.pagination.list).length)return void alert("必须勾选一条记录！");var e=o.getCheckedNew(T.pagination.list)[0];e.userRoles=null,e.auditDate=null,e.createTime=null,e.lastLoginTime=null,e.lastUpdTime=null,e.pwdLastUpd=null,e.statusLastUpd=null,l({modalTitle:"修改用户",modalBody:"toUpdate",url:"update",item:e,cached:{USER_TYPE:i.getCache("USER_TYPE"),DPET_NAME:i.getCache("DPET_NAME"),MERCHANT_CODE:i.getCache("MERCHANT_CODE")}})}function h(){return 1!=o.getCheckedNew(T.pagination.list).length?void alert("必须勾选一条记录！"):void t.post("delete",a({userId:o.getCheckedNew(T.pagination.list)[0].userId})).then(function(e){var t=e.data;t.success?(T.pagination.list.splice(T.pagination.list.indexOf(o.getCheckedNew(T.pagination.list)[0]),1),alert("操作成功")):alert("操作失败")},function(e){alert(e.statusText),n.debug("error")})}function f(e){return 1!=o.getCheckedNew(T.pagination.list).length?void alert("必须勾选一条记录！"):void t.post("audit",a({userId:o.getCheckedNew(T.pagination.list)[0].userId,userStatus:e})).then(function(e){var t=e.data;t.success?(alert("操作成功"),d()):alert("操作失败")},function(e){alert(e.statusText),n.debug("error")})}function E(e){l({modalTitle:"角色分配",modalBody:"toAllocate",url:"allocate",item:{user:e,roles:e.userRoles.map(function(e){return e.roleId})},cached:{ROLE_INFO_02:i.getCache("ROLE_INFO_02")}},function(e){T.queryDetail()},"RoleAllocateModalInstanceCtrl")}function C(e){l({modalTitle:"密码重置",modalBody:"toResetPwd",url:"resetPwd",item:{userName:e.userName,userId:e.userId}},function(){T.queryDetail()},"ResetPwdModalInstanceCtrl","myModalNoFooter.html")}var T=e.vm={};T.constant=s,T.pagination={pageSize:10,pageNum:1},T.queryBean={},T.validateOptions={blurTrig:!0,showError:function(e,t){u.addErrorMessage(t)},removeError:!0},T.cached={USER_TYPE:{},ROLE_INFO:{},USER_STATUS:{},DPET_NAME:{},MERCHANT_CODE:{},ROLE_INFO_02:{}},i.initCache(T.cached),T.getCache=function(e){return i.getCache(e)},T.getObj=function(e,l){return t.post(config.ctx+"/base/cache/getAll",a({cacheKey:e})).then(function(e){return r(c(e.data.object,l),6)},function(e){n.error("获取数据%s失败",cacheKey)})},T.queryDetail=d,T.resetForm=m,T.addItem=g,T.updateItem=p,T.deleteItem=h,T.auditItem=f,T.roleAllocate=E,T.resetPwd=C}]),angular.module("myApp").controller("RoleAllocateModalInstanceCtrl",["$scope","$uibModalInstance","modalItem","$http","$httpParamSerializerJQLike",function(e,t,a,n,l){var o=e.vm={modalTitle:"please change the title",modalBody:"#",url:"",item:{}};o.item.roles=[],o=e.vm=a,o.toggleCheck=function(e,t){e.target.checked?o.item.roles.push(t):o.item.roles.splice(o.item.roles.indexOf(t),1)},e.save=function(){n.post(o.url,l({userId:o.item.user.userId,roles:o.item.roles})).then(function(t){t.data.success?(alert("操作成功"),e.cancel()):alert(t.data.msg)},function(e){alert("操作失败"),alert(e.status)})},e.cancel=function(){t.dismiss("cancel")}}]),angular.module("myApp").controller("ResetPwdModalInstanceCtrl",["$scope","$uibModalInstance","modalItem","$http","myConstant",function(e,t,a,n,l){var o=e.vm={modalTitle:"please change the title",modalBody:"#",url:"",item:{}};o=e.vm=a,o.constant=l,e.save=function(){n.post(o.url,{userId:o.item.userId,userPwd:o.item.userPwd},config.jsonHeader).then(function(t){t.data.success?(alert("操作成功"),e.cancel()):alert("操作失败")},function(e){alert("操作失败"),alert(e.status)})},e.cancel=function(){t.dismiss("cancel")}}]);