angular.module("myApp").controller("queryCtrl",["$scope","$http","$httpParamSerializerJQLike","$log","OpenService","CheckboxService","CacheService","limitToFilter","filterFilter","myConstant",function(e,t,a,n,o,i,c,r,l,d){function u(){var e=document.getElementById("queryForm");f.url=angular.element(e).prop("action");var n=f.queryBean;n.pageSize=f.pagination.pageSize,n.pageNum=f.pagination.pageNum,t.post(f.url,a(n)).then(function(e){var t=e.data;t.success?(f.pagination=t.object,i.clearChecked()):alert(t.msg)})}function p(){var e=f.queryBean.companyType;f.queryBean={},f.queryBean.companyType=e}function m(e,t){i.updateChecked(e,t),n.debug(t),n.debug(i.getChecked())}function g(){t.post(config.ctx+"/merchant/trans/right/initResource",a({})).then(function(e){o({modalTitle:"增加交易权限",modalBody:"toAdd",url:"add",item:{treeData:e.data.object},cached:{MERCHANT_CODE:c.getCache("MERCHANT_CODE")}},function(e){},"privateMerchantCtrl","myModalNoFooter.html")},function(e){alert("访问失败")})}function h(){if(1!=i.getCheckedNew(f.pagination.list).length)return void alert("必须勾选一条记录！");var e=i.getCheckedNew(f.pagination.list)[0].companyCode;n.info("----%s",e),t.post(config.ctx+"/merchant/trans/right/initResource",a({merchantCode:e,companyType:f.queryBean.companyType})).then(function(t){o({modalTitle:"交易权限权限分配",modalBody:"toUpdate",url:"update",item:{merchantCode:e,treeData:t.data.object,MERCHANT_CODE:f.cached.MERCHANT_CODE}},function(e){},"privateMerchantCtrl","myModalNoFooter.html")},function(e){alert("访问失败")})}function s(){return 1!=i.getCheckedNew(f.pagination.list).length?void alert("必须勾选一条记录！"):void(confirm("是否确认此操作?")&&t.post("delete",a({companyCode:i.getCheckedNew(f.pagination.list)[0].companyCode})).then(function(e){var t=e.data;t.success?(f.pagination.list.splice(f.pagination.list.indexOf(i.getCheckedNew(f.pagination.list)[0]),1),f.queryDetail(),alert("操作成功")):alert("操作失败")},function(e){alert(e.statusText),n.debug("error")}))}var f=e.vm={};f.constant=d,f.pagination={pageSize:10,pageNum:1},f.queryBean={},f.reverseFlag={1:"正交易",0:"反交易"},f.splitRightFlag={0:"分账交易",1:"非分账交易"},f.cached={MERCHANT_CODE:{},TRANS_CODE_ALL:{},CONN_CHANNEL:{},REFUND_FLAG:{}},c.initCache(f.cached),f.getCache=function(e){return c.getCache(e)},f.getObj=function(e,o){return t.post(config.ctx+"/base/cache/getAll",a({cacheKey:e})).then(function(e){return r(l(e.data.object,o),6)},function(e){n.error("获取数据%s失败",cacheKey)})},f.queryDetail=u,f.resetForm=p,f.updateChecked=m,f.addItem=g,f.updateItem=h,f.deleteItem=s}]),angular.module("myApp").controller("privateMerchantCtrl",["$scope","$uibModalInstance","modalItem","$http","$httpParamSerializerJQLike","$log","$timeout",function(e,t,a,n,o,i,c){var r=e.vm={modalTitle:"please change the title",modalBody:"#",url:"",item:{id:"",treeData:{}}};r=e.vm=a,c(function(){function e(t,a){t.nodes&&t.nodes.length>0&&t.nodes.forEach(function(t){e(t,a)}),a.push({id:t.id,pId:t.pid,name:t.name,checked:t.checked})}var t={check:{enable:!0},data:{simpleData:{enable:!0}}},a=[];r.item.treeData.forEach(function(t){e(t,a)}),$.fn.zTree.init(angular.element(".ztree"),t,a)},1e3),e.save=function(){var e=$.fn.zTree.getZTreeObj("treeDemo"),a=e.getCheckedNodes(),c=[];if(0==a.length)return alert("操作失败,渠道/订单类型不能为空"),!1;for(var l in a){var d={acqOrgCode:r.item.acqOrgCode,companyType:r.item.companyType,companyCode:r.item.merchantCode,transCode:a[l].id,connChannel:a[l].pId};c.push(d)}i.debug("交易权限:"+JSON.stringify(c)+"----"+r.item.companyType),n.post(r.url,o({tempParams:JSON.stringify(c)})).then(function(e){e.data.success?(alert("操作成功"),t.close(r.item)):alert(e.data.msg)},function(e){alert("操作失败")})},e.cancel=function(){t.dismiss("cancel")}}]);